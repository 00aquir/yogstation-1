
/datum/software/malware
	var/antivirus_resistance = 0

/datum/software/malware/copy()
	var/datum/software/malware/the_copy = ..()
	if(the_copy)
		the_copy.antivirus_resistance = src.antivirus_resistance
	return the_copy

/datum/software/malware/mutate()
	if(..())
		antivirus_resistance = Clamp(infect_chance + rand(-2, 2), 0, 100)
		return 1
	return 0

///////////////////////
//HONK
///////////////////////
/datum/software/malware/honkvirus
	name = "clown virus"
	flags = SOFTWARE_NOSPREAD
	can_infect = list(/obj/item/device/pda)
	var/honkChance = 60
	var/honks_remaining = 0
	var/last_honk = 0

/datum/software/malware/honkvirus/New()
	..()
	honks_remaining = rand(15,20)

/datum/software/malware/honkvirus/onTopicCall(href, href_list)
	if(prob(honkChance))
		honk()
	return 0

/datum/software/malware/honkvirus/onActivate(mob/user)
	if(prob(honkChance))
		honk()
	return 0

/datum/software/malware/honkvirus/on_join(datum/software/malware/honkvirus/other)
	if(istype(other, type))
		var/datum/software/malware/honkvirus/HV = other
		honks_remaining += HV.honks_remaining
		honkChance = max(other.honkChance, honkChance)
		return 1
	return 0

/datum/software/malware/honkvirus/proc/honk()
	if(world.time - last_honk < 1)
		return
	last_honk = world.time
	honks_remaining--
	playsound(get_turf(host), 'sound/items/bikehorn.ogg', 30, 1)
	if(honks_remaining < 1)
		uninfect()

///////////////////////
//*silence*
///////////////////////
/datum/software/malware/mimevirus
	name = "mime virus"
	flags = SOFTWARE_NOSPREAD
	can_infect = list(/obj/item/device/pda)

/datum/software/malware/mimevirus/infect()
	if(!..())
		return 0
	if(host)
		var/obj/item/device/pda/PDA = host
		PDA.silent = 1
		PDA.ttone = "silence"
		uninfect()
		return 1
	return 0

///////////////////////
//Detomatix
///////////////////////
/datum/software/malware/detomatix
	name = "detomatix"
	flags = SOFTWARE_NOSPREAD|SOFTWARE_NOMUTATE|SOFTWARE_ANTIVIRUS_IMMUNE
	can_infect = list(/obj/item/device/pda)

/datum/software/malware/detomatix/infect()
	if(!..())
		return 0
	if(host)
		var/obj/item/device/pda/PDA = host
		PDA.explode()
		uninfect()
		return 1
	return 0

///////////////////////
//Adware
///////////////////////
/datum/software/malware/adware
	name = "adware"
	infect_chance = 70
	var/popup_chance = 20
	var/popup_chance_min = 20
	var/popup_chance_max = 20
	var/global/ad_id = 0

/datum/software/malware/adware/mutate()
	..()
	popup_chance = Clamp(popup_chance + rand(-2, 4), popup_chance_min, popup_chance_max)

/datum/software/malware/adware/onActivate(mob/user)
	if(prob(popup_chance))
		showAd(user)
		return 1
	return 0

/datum/software/malware/adware/onTopicCall(href, href_list)
	if(!istype(host, /obj/item/device/pda) && !istype(host, /obj/machinery/computer))
		return 0
	if(prob(popup_chance))
		showAd(usr)
		return 1
	return 0

/datum/software/malware/adware/proc/showAd(mob/user)
	if(!user)
		return
	popup_chance = max(popup_chance - 2, popup_chance_min) //have mercy
	var/dat = "this is an ad."
	user << browse(dat, "window=ad[ad_id++];size=400x450;border=1;can_resize=0;can_minimize=0")

